---
title: Docker 둘러 보기
date: 2019-05-16 00:00:00 +0300
description: 
cover: /assets/post_img/docker_2.png
tags: 
---
<center><img src="{{site.baseurl}}/assets/post_img/docker_2.png"></center>
<div style="text-align: center;">
    <span style="font-size:11px; color:grey">
        이 정적 페이지는 PC 버전에 최적화가 되어 있습니다.  
    </span>
</div>

## TODO: 내 개발환경 도커로 이미지 떠보자!

## 개요
공식 문서( https://www.docker.com/)  
정의 : 리눅스 컨테이너 기반의 오픈 소스 소프트웨어 플랫폼입니다.  
설치
리눅스 : ```curl -fsSL https://get.docker.com/ | sudo sh```  
윈도우 (hyper-v): docker for window  
맥(xhyve) : docker for mac or brew cask install docker  
기본 명령어 모음 (https://docs.docker.com/engine/reference/commandline/docker/) 

일반적으로 프로그램 개발에 필수 요소는
- 실행 모듈(game.exe)
- 실행에 필요한 라이브러리군 혹은 미들웨어(redis, cocos2d, http, socket 등등 ..)
- 운영체제, 네트워크 등의 인프라 환경  

으로 구성됩니다.  
a라는 게임을 개발하기 위해선 모두 같은 개발 환경을 가져야 합니다.
하지만 라이브러리의 버전이 다르거나 운영체제 등이 상이하여 문제가 발생할 수 있습니다.
docker라는 소프트웨어를 사용해 개발 환경을 컨테이너 안에 이미지로 생성해 공유할 수 있습니다.
따라서 DockerFile만 docker-hub 혹은 jenkins을 통해 수정, 배포 한다면 지속적인 딜리버리가 가능합니다.
즉, 클릭 몇 번만으로 서버 복제가 가능합니다.

## 등장 배경
서비스의 서버 운영 방식이 직접 물리 서버 운영 -> 호스팅 방식 -> 클라우드 서비스 운영 방식(AWS, NBP)으로 변하면서
가상 서버가 너무 많아졌습니다. 이에 따라 쉽게 서버 환경을 공유할 필요성이 생겼습니다.

## 가상화
CPU, RAM 등에 물리적 자원에 얽매이지 않고 가상의 단위로 분리하여 여러 서버를 운영할 수 있도록 하는 기술입니다.
예를 들어 맥북 한대를 샀지만 패럴러즈로 윈도우 운영체제를 사용한다면 한 대의 맥북에서 가상화를 통해 두 시스템을 사용하는 것입니다.

## 하이퍼바이저형 가상화 (type1)
하드웨어 자체를 가상화하기 때문에 베어 메탈 방식이라고도 불립니다.
하이퍼바이저는 각 OS에게 자원을 나눠주기도 커널 명령어를 해석해 HW에게 전달해주는 역할을 합니다. 
계층 구조는 HW - 하이퍼바이저(VMM) - GuestOS 입니다.
하드웨어 위의 하이퍼바이저가 구동되어 각각의 guestOS를 수행합니다.
전가상화의 경우, DOM0라는 관리용 가상 머신이 guestOS에게 받은 제어 요구를 하이퍼바이저에게 명령 및 자원을 요청, guestOS에게 다시 전달합니다.
하드웨어 자체를 완전히 가상화하기 때문에 게스트 OS에는 별도의 수정 필요없이 전달 받은 명령만 수행합니다. 
하지만 하이퍼바이저가 HW와 게스트 OS 사이에서 모든 명령을 중재하기 때문에 binaray transaction으로 인한 성능 저하가 발생합니다. 
이러한 한계를 극복하기 위해 반가상화가 존재합니다.
하드웨어를 완전히 가상화하지 않고 guestOS가 하이퍼 콜이라는 인터페이스로 직접 하이퍼바이저이게 요청을 날리고 명령 및 자원을 받는 방식입니다.
이러한 하이퍼콜을 게스트 OS가 하기 위해선 가상화 여부를 알고 있으며 게스트 OS의 커널 수정이 반드시 필요하다는 단점이 있습니다. 
 
## 호스트형 가상화 (type2)
일반적으로(?) 자주 쓰이는 가상화의 방식으로 Host OS가 설치 및 실행되고 그 위에 guest OS가 실행되는 방식입니다.
HW - host OS - VMM - guest OS의 구조입니다.
따라서 리눅스에서 윈도우를 구동하거나 윈도우에서 우분투 등을 실행하는 방식입니다.
손쉽게 구축이 가능하지만 host OS 위에 guest OS를 설치하기 때문에 물리적인 오버헤드가 큽니다. 

## 동작 원리
하드웨어의 가상화 계층 (hyper-v)이나 guestOS 설치 없이 hostOS의 자원을 직접 이용하는 방식입니다.
따라서 메모리 접근, 파일 시스템, 네트워크 등의 속도가 월등히 빠릅니다. 
기존의 가상화는 OS를 통째로 가상화했다면 docker는 리눅스 커널 레벨에서 격리하기 때문에 가상 머신이 아닌 컨테이너라고 부릅니다. 

## 특징
1.github와 유사하게 docker hub를 통해 컨테이너 이미지 생성 및 공유가 가능합니다.  
2.docker-compose라는 cli을 통해 여러 Docker 컨테이너를 통합적으로 관리할 수 있습니다.  
3.docker-compose.yml을 통해 컨테이너 아키텍처를 공유, 구성할 수 있습니다.  
4.컨테이너 기반을 이용하여 단순한 저장공간 컨테이너(볼륨)를 만들어 저장공간을 container끼리 연결할 수 있으며, 실행한 호스트의 저장공간에도 접근가능합니다.  
5.Docker는 다양한 API를 제공합니다.   


## Docker에서 컨테이너(Container) 의 특징
Docker에서 컨테이너는 이미지를 실행한 상태이며, 이미지를 여러개의 컨테이너로 만들수있는 하나의 격리된 공간이다. Docker는 Dockerfile파일을 이용하여 컨테이너를 구성할 수 있다. 아무런 docker프로젝트에 들어가서 프로젝트안에 있는 Dockerfile를 아무 지식없이 열어보면 해당 이미지를 만들어내기 위한 인스톨 및 작업에 대한 명령어들이 모아져있는것을 알 수 있다. Docker는 컨테이너를 만들때 스크립트의 조합으로 만들 수 있다. Docker의 컨테이너는 스크립트로만 만들긴 하는데.. 그럼 그 스크립트를 구동시키는 기본적인 Guest OS는 script로 만들어지지 않는데… Docker의 컨테이너는 두 타입으로 나눌 수 있다. 베이스 컨테이너와 애플리케이션 컨테이너 이때 의문이었던 script를 구동시키는것이 바로 베이스 컨테이너이고, 여러 프로그램을 붙이고 구성해놓은것이 바로 애플리케이션 컨테이너이다.
운영체제로 보면 이미지는 실행파일, 컨테이너는 프로세스 즉, Docker는 특정 실행파일 또는 스크립트를 위한 실행 환경
컨테이너는 가상화보다 훨씬 가벼운 가상화 기술이다. 리눅스 안에 있는 컨테이너 기술을 이용하여 가상공간을 만든다. 하지만, 그 만들어진 공간안에 실행파일은 호스트에서 직접 실행한다. 어찌 보면 컨테이너는 가상화가 아닌 격리의 개념과도 같다. 이 컨테이너 기술은 리눅스의 LXC의 cgroups 와 namespaces가 제공하는 기술 컨테이너에 대한 내용은 아래 링크를 반드시 참조한다.

## Docker 이미지 생성
DokcerFile 스크립트 작성을 통해 만듭니다.

## Container
도커 이미지를 실행한 상태입니다. 

## Image (Immutable)
컨테이너 실행에 필요한 파일과 설정값 등을 포함하고 있는 파일입니다.

## [tmi] docker와 nox
안드로이드 가상화 소프트웨어 nox는 intel의 vt-x를 사용합니다.
이 기술은 서버 가상화를 위한 hyper-v와 동시에 사용할 수 없습니다. 
중첩 가상화에 많은 기능 제약이 있어서 블루 스크린을 유발합니다.
따라서 nox를 사용하기 위해선 win의 hyper-v 기능을 제거해야 하므로 
현재 win에서 동시에 docker와 nox의 사용하는 것은 불가능합니다.

## [tmi] win 10에서 docker가 crash 나는 이유
win 10에서 간혹 docker(고래)가 crash나는 경우가 있었습니다. (주로 컴퓨터 부팅 후)  
그냥 restart하는 방법으로 간단히 해결할 수 있지만  
근본적인 원인이 궁금했고 그 결과 win10의 fast startup에 있었습니다.  
win 10이 fast startup 옵션이 켜져있으면 무언가 독커가 이미지를 사용하기도 전에 처리되는 것 같습니다.  
출처 : (https://www.tenforums.com/tutorials/4189-turn-off-fast-startup-windows-10-a.html)

